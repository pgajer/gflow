#!/usr/bin/env sh
# Fail fast
set -eu

PROFILE="${GFLOW_BUILD_PROFILE:-dev}"

case "$PROFILE" in
  dev|cran-safe)
    ;;
  *)
    echo "configure: unsupported GFLOW_BUILD_PROFILE='$PROFILE' (use 'dev' or 'cran-safe')" 1>&2
    exit 1
    ;;
esac

echo "configure: selected build profile: $PROFILE" 1>&2
echo "configure: probing for sanitizer flags" 1>&2

ALLFLAGS="${CFLAGS:-} ${CPPFLAGS:-} ${CXXFLAGS:-} ${CXX11FLAGS:-} ${CXX14FLAGS:-} ${CXX17FLAGS:-} ${CXX20FLAGS:-} ${LDFLAGS:-}"
SAN_LINE=""

case "$ALLFLAGS" in
  *-fsanitize=address*|*-fsanitize=undefined*|*-fsanitize=leak*)
    echo "configure: sanitizer detected -> using RcppParallel TinyThread backend" 1>&2
    SAN_LINE="export RCPP_PARALLEL_BACKEND=tinythread"
    ;;
  *)
    echo "configure: no sanitizer flags found (keeping default RcppParallel backend)" 1>&2
    ;;
esac

mkdir -p src
{
  echo "# Auto-generated by configure. Do not edit by hand."
  echo "GFLOW_BUILD_PROFILE := $PROFILE"
  if [ -n "$SAN_LINE" ]; then
    echo "$SAN_LINE"
  fi
} > src/Makevars.local

echo "configure: wrote src/Makevars.local" 1>&2

exit 0
