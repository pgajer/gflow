name: rdgraph-tests

on:
  pull_request:
  push:
    branches:
      - main
      - master
  schedule:
    # Nightly, every day (includes weekends), 03:00 UTC.
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      run_slow:
        description: "Run slow runtime guardrail tests"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  fast-rdgraph-tests:
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_slow != 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: check
          extra-packages: |
            any::pkgload
            any::testthat
            biclust=url::https://cran.r-project.org/src/contrib/Archive/biclust/biclust_2.0.3.1.tar.gz
            s4vd=url::https://cran.r-project.org/src/contrib/Archive/s4vd/s4vd_1.1-1.tar.gz

      - name: Verify archived optional dependency installs
        run: |
          Rscript -e 'pkgs <- c("biclust", "s4vd"); for (p in pkgs) { if (!requireNamespace(p, quietly = TRUE)) stop("Missing package: ", p); cat(p, as.character(utils::packageVersion(p)), "\n") }'

      - name: Run fast rdgraph tests
        run: |
          Rscript - <<'RS'
          pkgload::load_all('.', quiet = TRUE)
          testthat::test_file('tests/testthat/test-rdgraph-iknn-invariance.R')
          testthat::test_file('tests/testthat/test-rdgraph-geometric-pruning-switch.R')
          RS

  nightly-runtime-guardrails:
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_slow == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      NOT_CRAN: "true"
      GFLOW_RUN_SLOW_TESTS: "true"

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: check
          extra-packages: |
            any::pkgload
            any::testthat
            biclust=url::https://cran.r-project.org/src/contrib/Archive/biclust/biclust_2.0.3.1.tar.gz
            s4vd=url::https://cran.r-project.org/src/contrib/Archive/s4vd/s4vd_1.1-1.tar.gz

      - name: Verify archived optional dependency installs
        run: |
          Rscript -e 'pkgs <- c("biclust", "s4vd"); for (p in pkgs) { if (!requireNamespace(p, quietly = TRUE)) stop("Missing package: ", p); cat(p, as.character(utils::packageVersion(p)), "\n") }'

      - name: Run nightly runtime guardrail tests
        run: |
          Rscript - <<'RS'
          pkgload::load_all('.', quiet = TRUE)
          testthat::test_file('tests/testthat/test-rdgraph-runtime-sanity.R')
          RS
